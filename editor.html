<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YGO Lightning</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      body {
        background-color: #000000;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Bahnschrift";
        font-weight: lighter;
        font-size: 25px;
        color: #ffffff;
      }
      #body {
        display: flex;
        border-width: 2px;
        border-color: #5e3cb3;
        border-style: solid;
      }
      #body > div {
        margin: 10px;
      }
      .purple {
        background-color: #0d071b;
        border-width: 4px;
        border-color: #5e3cb3;
        border-style: solid;
      }
      p {
        margin-top: 15px;
      }
      input {
        padding: 5px;
        font-size: 25px;
        font-family: "Bahnschrift";
        font-weight: lighter;
        color: #ffffff;
        background-color: #201834;
        border: none;
        width: 300px;
        margin-bottom: 10px;
      }
      textarea {
        padding: 5px;
        font-size: 25px;
        font-family: "Bahnschrift";
        font-weight: lighter;
        color: #ffffff;
        background-color: #201834;
        border: none;
        width: 300px;
        height: 200px;
        margin-right: 10px;
        margin-top: 10px;
        resize: none;
      }
      button {
        width: 200px;
        height: 50px;
        background-color: #201834;
        font-family: "Bahnschrift";
        font-weight: lighter;
        font-size: 20px;
        color: #ffffff;
        border-width: 4px;
        border-color: #5e3cb3;
        border-style: solid;
        cursor: pointer;
        padding: 0px;
        outline: none;
        margin-bottom: 10px;
      }
      button:hover {
        background-color: #5e3cb3;
      }
      .minibtn {
        width: 150px;
        height: 40px;
        font-size: 15px;
        border-width: 3px;
      }
      .filterbtn {
        width: 100px;
        height: 40px;
        font-size: 15px;
        border-width: 3px;
      }
      select {
        width: 400px;
        height: 50px;
        background-color: #201834;
        font-family: "Bahnschrift";
        font-weight: lighter;
        font-size: 20px;
        color: #ffffff;
        border-width: 2px;
        border-color: #000000;
        border-style: solid;
        cursor: pointer;
      }
      #main {
        margin-bottom: 10px;
        padding: 10px;
        width: 665px;
        height: 400px;
        overflow-y: scroll;
      }
      #extra {
        padding: 10px;
        width: 665px;
        height: 190px;
        overflow-y: scroll;
      }
      #searchResult {
        width: 415px;
        height: 400px;
        overflow-y: scroll;
        margin-bottom: 10px;
      }
      #popupCss1 {
        width: 100vw;
        height: 100vh;
        margin: 0px;
        padding: 0px;
        z-index: 9999;
        position: fixed;
        display: none;
        justify-content: center;
      }
      #popupCss2 {
        height: 100vh;
        margin: 0px;
        padding: 0px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      #popup {
        width: 800px;
        min-height: 600px;
        max-height: 85vh;
        overflow: scroll;
        background-color: #000000dd;
        padding: 20px;
        justify-content: center;
        font-size: 15px;
        position: relative;
      }
      .cardname {
        font-size: 20px;
        text-align: center;
      }
      .filterheader {
        font-size: 25px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="popupCss1">
      <div id="popupCss2">
        <div id="popup"></div>
      </div>
    </div>
    <div id="body">
      <div id="deck">
        <button id="btnFormat" class="minibtn" onclick="switchFormat()">
          Format: TCG
        </button>
        <button class="minibtn" onclick="sortDeck()">Sort Deck</button>
        <button class="minibtn" id="btnControl" onclick="showControls()">
          Editor Menu
        </button>
        <button id="switchMainSide" class="minibtn" onclick="switchMainSide()">
          View Side Deck
        </button>
        <button id="switchMode" class="minibtn" onclick="switchMode()">
          Mode: View</button
        ><br />
        <div id="main" class="purple"></div>
        <div id="extra" class="purple"></div>
      </div>
      <div id="controls">
        <input
          id="deckName"
          value="Untitled Deck"
          type="text"
          placeholder="Deck name..."
          autocomplete="off"
        />
        <button class="filterbtn" id="btnViewDeck" onclick="showControls()">
          View Deck</button
        ><br />
        <input
          id="searchInput"
          type="text"
          placeholder="Search card..."
          onkeyup="cardSearch()"
          autocomplete="off"
        />
        <button class="filterbtn" onclick="openFilter()">Options</button>
        <div id="searchResult" class="purple"></div>
        <button onclick="testHands()">Test Hands</button>
        <button id="copyYdke" onclick="copyYdke()">Copy ydke</button><br />
        <button onclick="saveDeck()">Save and Exit</button>
        <button onclick="exit()">Exit</button>
      </div>
    </div>
  </body>
  <script src="v1/profile.class.js"></script>
  <script src="v1/ygolDb.js"></script>
  <script src="v1/ygolID.js"></script>
  <script src="v1/banlistDl.js"></script>
  <script src="v1/banlistMd.js"></script>
  <script src="v1/banlistTcg.js"></script>
  <script src="v1/banlistOcg.js"></script>
  <script src="v1/ygolDeck.class.js"></script>
  <script src="v1/deckBuilder.class.js"></script>
  <script>
    //hold click to view card
    let cardwidth = 65;
    let main = document.getElementById("main");
    let extra = document.getElementById("extra");
    let searchResult = document.getElementById("searchResult");
    let profile = new Profile("");
    let ygolDeck = new YgolDeck(cardDb, ygolID, false);
    let deckBuilder = new DeckBuilder(cardDb);
    deckBuilder.addBanlist("dl", banlistDl);
    deckBuilder.addBanlist("md", banlistMd);
    deckBuilder.addBanlist("tcg", banlistTcg);
    deckBuilder.addBanlist("ocg", banlistOcg);
    deckBuilder.addBanlist("unlimited", []);
    let format = "tcg";
    deckBuilder.changeFormat(format);
    let originalDeckName = "";
    let currentCard = "";
    let cardDivId = "";
    let mousedown = false;
    let mousehold = false;
    let poppingup = false;
    let selectingFilters = false;
    let filters = [];
    let sort = "Popularity";
    let holdThreshold = 500;
    let _isMobile = window.innerHeight > window.innerWidth;
    let editMode = "edit";

    //mobile view
    if (_isMobile) {
      editMode = "view";
      document.getElementById("deck").style.width = "90vw";
      document.getElementById("body").style.display = "block";
      document.getElementById("main").style.width = "80vw";
      document.getElementById("main").style.height = "50vh";
      document.getElementById("extra").style.width = "80vw";
      document.getElementById("extra").style.height = "20vh";
      cardwidth = window.innerWidth / 8;
      document.getElementById("controls").style.display = "none";
      document.getElementById("searchResult").style.width = "80vw";
      document.getElementById("popup").style.width = "95vw";
      document.head.insertAdjacentHTML(
        "beforeend",
        "<style>*{font-weight: 500;} .minibtn{width: 30vw; height: 7vw; font-size: 3.2vw;} .filterbtn{width: 20vw; height: 7vw; font-size: 2.7vw;} button{width: 40vw; height: 8vw; font-size: 4vw; font-weight: 500;} #popup{font-size: 3.5vw;} .cardname{font-size: 4.2vw;}</style>"
      );
      for (let el of document.querySelectorAll("input")) {
        el.style.width = "55vw";
      }
      for (let el of document.querySelectorAll("button")) {
        if (el.classList.contains("minibtn")) {
          el.style.width = "27vw";
        }
      }
    } else {
      document.getElementById("btnControl").style.display = "none";
      document.getElementById("btnViewDeck").style.display = "none";
      document.getElementById("switchMode").style.display = "none";
    }

    function showControls() {
      if (document.getElementById("controls").style.display == "none") {
        document.getElementById("controls").style.display = "block";
        document.getElementById("deck").style.display = "none";
      } else {
        document.getElementById("controls").style.display = "none";
        document.getElementById("deck").style.display = "block";
      }
    }

    function switchMode() {
      if (editMode == "view") {
        editMode = "edit";
        document.getElementById("switchMode").innerHTML = "Mode: Edit";
      } else {
        editMode = "view";
        document.getElementById("switchMode").innerHTML = "Mode: View";
      }
    }

    document.addEventListener("mousedown", (event) => {
      mousedown = true;
      setTimeout(() => {
        if (mousedown) mousehold = true;
      }, holdThreshold);
    });
    document.addEventListener("mouseup", (event) => {
      if (
        !mousehold &&
        (cardDivId == "main" ||
          cardDivId == "extra" ||
          cardDivId == "searchResult")
      ) {
        if (editMode == "edit") {
          if (cardDivId == "searchResult") {
            deckBuilder.addCard(currentCard, main, extra, cardwidth);
          } else {
            deckBuilder.removeCard(currentCard, main, extra, cardwidth);
          }
        } else {
          document.getElementById("popupCss1").style.display = "flex";
          deckBuilder.displayCard(
            currentCard,
            document.getElementById("popup"),
            window.innerWidth / 3
          );
        }
      }
      if (poppingup)
        document.getElementById("popupCss1").style.display = "none";
      mousedown = false;
      mousehold = false;
      poppingup = false;
      currentCard = "";
      cardDivId = "";
    });
    document
      .getElementById("popupCss1")
      .addEventListener("mouseup", (event) => {
        if (!selectingFilters) {
          document.getElementById("popupCss1").style.display = "none";
          let input = document.getElementById("searchInput").value;
          if (input.length > 2 || filters.length) {
            deckBuilder.searchCard(
              input,
              searchResult,
              cardwidth,
              filters,
              sort
            );
          }
        }
        selectingFilters = false;
      });
    setInterval(() => {
      if (mousehold && currentCard && !poppingup) {
        poppingup = true;
        document.getElementById("popupCss1").style.display = "flex";
        deckBuilder.displayCard(
          currentCard,
          document.getElementById("popup"),
          160
        );
      }
    }, 100);
    function updateFilterDisplay() {
      for (let el of document
        .getElementById("popup")
        .querySelectorAll("button")) {
        el.style.backgroundColor = "#201834";
        if (el.innerHTML.replace(/^\s+|\n/g, "") == sort) {
          el.style.backgroundColor = "#5e3cb3";
        }
        for (let innerHTML of filters) {
          if (el.innerHTML.replace(/^\s+|\n/g, "") == innerHTML) {
            el.style.backgroundColor = "#5e3cb3";
          }
        }
      }
    }
    function cardClicked(divid, cardname) {
      currentCard = cardname;
      cardDivId = divid;
    }
    function cardSearch() {
      let input = document.getElementById("searchInput").value;
      setTimeout(() => {
        if (
          (input.length > 2 || filters.length) &&
          input == document.getElementById("searchInput").value
        ) {
          deckBuilder.searchCard(input, searchResult, cardwidth, filters, sort);
        }
      }, 500);
    }
    function openFilter() {
      document.getElementById("popup").innerHTML = editorFilters;
      document.getElementById("popupCss1").style.display = "flex";
      updateFilterDisplay();
    }
    function selectFilter(innerHTMLWithSpaces) {
      let innerHTML = innerHTMLWithSpaces.replace(/^\s+|\n/g, "");
      selectingFilters = true;
      if (filters.includes(innerHTML)) {
        filters = filters.filter((a) => a != innerHTML);
      } else {
        filters.push(innerHTML);
      }
      updateFilterDisplay();
    }
    function clearFilters() {
      selectingFilters = true;
      filters.length = 0;
      updateFilterDisplay();
    }
    function selectSort(innerHTMLWithSpaces) {
      selectingFilters = true;
      sort = innerHTMLWithSpaces.replace(/^\s+|\n/g, "");
      updateFilterDisplay();
    }
    function switchMainSide() {
      document.getElementById("switchMainSide").innerHTML =
        deckBuilder.switchEditingDeck(main, extra, cardwidth);
    }
    function switchFormat() {
      let arrFormats = ["dl", "md", "tcg", "ocg", "unlimited"];
      format = arrFormats[(arrFormats.indexOf(format) + 1) % arrFormats.length];
      document.getElementById(
        "btnFormat"
      ).innerHTML = `Format: ${format.toUpperCase()}`;
      deckBuilder.changeFormat(format);
      if (deckBuilder.editingDeck == "main") {
        deckBuilder.appendDeck(main, extra, cardwidth);
      } else {
        deckBuilder.appendSide(main, extra, cardwidth);
      }
      let input = document.getElementById("searchInput").value;
      if (input.length > 2 || filters.length) {
        deckBuilder.searchCard(input, searchResult, cardwidth, filters, sort);
      }
    }
    function sortDeck() {
      deckBuilder.sortDeck(main, extra, cardwidth, format);
    }
    function testHands() {
      let namelist = deckBuilder.exportNamelist();
      let yld = "";
      for (let el of profile.decks) {
        if (el.name == originalDeckName) {
          el.name = document.getElementById("deckName").value;
          el.yld = ygolDeck.namelist_to_yld(namelist).replace("yld://", "");
          yld = el.yld;
        }
      }
      window.open(
        `test-hands.html?yld=${yld}&matsrc=${encodeURIComponent(
          profile.mat
        )}&sleevesrc=${encodeURIComponent(profile.sleeve)}`
      );
    }
    function copyYdke() {
      let input = document.createElement("textarea");
      input.innerHTML = ygolDeck.convert(deckBuilder.exportNamelist(), "ydke");
      document.body.appendChild(input);
      input.select();
      if (document.execCommand("copy")) {
        document.body.removeChild(input);
        document.getElementById("copyYdke").innerHTML = "Copied!";
        setTimeout(() => {
          document.getElementById("copyYdke").innerHTML = "Copy ydke";
        }, 2000);
      }
    }
    function saveDeck() {
      for (let el of profile.decks) {
        if (el.name == originalDeckName) {
          el.name = document.getElementById("deckName").value;
          el.yld = ygolDeck
            .convert(deckBuilder.exportNamelist(), "yld")
            .replace("yld://", "");
        }
      }
      window.open(
        "index.html?p=" + encodeURIComponent(profile.createURL()),
        "_self"
      );
    }
    function exit() {
      window.open(
        "index.html?p=" + encodeURIComponent(profile.createURL()),
        "_self"
      );
    }
    const params = new URL(document.location).searchParams;
    const p = params.get("p");
    if (p) {
      profile.unpackURL(p);
      if (params.get("yld") != null) {
        originalDeckName = profile.decks.filter(
          (a) => a.yld == params.get("yld")
        )[0].name;
        document.getElementById("deckName").value = originalDeckName;
        deckBuilder.importNamelist(
          ygolDeck.convert("yld://" + params.get("yld"), "namelist"),
          main,
          extra,
          cardwidth
        );
      }
    }
  </script>
</html>
